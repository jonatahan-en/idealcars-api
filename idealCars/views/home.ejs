<%- include("header.ejs") %>
<link rel="stylesheet" href="/css/splash.css">
<div class="splash-container">
    <div class="logo-container">
        <div class="logo-text">idealCars</div>
        <div class="logo-tagline"><%= __('home.tagline') %></div>
    </div>
</div>

<!-- Variable global de im√°genes para el script -->
<script>
    // Inicializar el objeto de im√°genes de productos
    const product_images = {};
    <%
    if (products && products.length > 0) {
        products.forEach(product => {
            if (product.images && product.images.length > 0) {
    %>
    product_images["<%= product.id %>"] = <%- JSON.stringify(product.images) %>;
    <%
            }
        });
    }
    %>
</script>

<main class="main-bg-container container py-3">

    <h3 class="mb-2" style="font-size:1.5rem; font-weight:600;">üöó <%= __('home.welcome') %>
        <% if(session.userName) { %>
        ü´Ç<a style="text-decoration: none; color: #00bfff"  href="/profile/"><%= session.userName %></a>
        <% } %>
        </h3>    <% if (!session.userId) { %>
        <!--<div class="alert alert-info mb-2" role="alert">
            <%= __('home.loginPrompt') %>
        </div>-->
        <% } %>
    <h2 class="mb-2"><%= __('home.userProducts') %></h2>
    <button class="filter-button" onclick="toggleFilters()">
        <i class="bi bi-funnel-fill"></i> <%= __('common.filter') %>
    </button>
    <div id="filter-form" style="display: none;">
        <form action="/" method="GET" class="filter-form">
            <div class="row g-2">
                <div class="col-6 col-sm-4 col-md-2">
                    <label for="brand"><%= __('home.filters.brand') %>:</label>
                    <input type="text" id="brand" name="brand" placeholder="<%= __('home.filters.brand') %>">
                </div>
                <div class="col-6 col-sm-4 col-md-2">
                    <label for="model"><%= __('home.filters.model') %>:</label>
                    <input type="text" id="model" name="model" placeholder="<%= __('home.filters.model') %>">
                </div>
                <div class="col-6 col-sm-4 col-md-2">
                    <label for="color"><%= __('home.filters.color') %>:</label>
                    <input type="text" id="color" name="color" placeholder="<%= __('home.filters.color') %>">
                </div>
                <div class="col-6 col-sm-4 col-md-2">
                    <label for="year"><%= __('home.filters.year') %>:</label>
                    <input type="number" id="year" name="year" placeholder="<%= __('home.filters.year') %>">
                </div>
                <div class="col-6 col-sm-4 col-md-2">
                    <label for="price"><%= __('home.filters.price') %>:</label>
                    <input type="number" id="price" name="price" placeholder="<%= __('home.filters.price') %>">
                </div>
                <div class="col-6 col-sm-4 col-md-2">
                    <label for="kilometer"><%= __('home.filters.kilometer') %>:</label>
                    <input type="number" id="kilometer" name="kilometer" placeholder="<%= __('home.filters.kilometer') %>">
                </div>
                <div class="col-12 text-center">
                    <button type="submit" class="btn btn-primary mt-2"><%= __('home.filters.button') %></button>
                </div>
            </div>
        </form>
    </div>
    <hr class="my-2">
    <div class="row row-cols-1 row-cols-sm-2 row-cols-md-3 row-cols-lg-4 g-4">
        <% if (products && products.length > 0) { %>
            <% products.forEach(product => { %>
                <div class="col">
                    <div class="ProductCard h-100">
                        <% if (product.images && product.images.length > 0) { %>
                            <div class="product-carousel">
                                <img src="/<%= product.images[0].startsWith('img_cars/') ? '' : 'imagenes/' %><%= product.images[0] %>" class="card-img-top active-image" alt="<%= product.brand %> <%= product.model %>" data-index="0">
                                <% if (product.images.length > 1) { %>
                                    <div class="carousel-nav">
                                        <button class="mini-nav-btn prev" onclick="moveProductImage(this, -1)">&#10094;</button>
                                        <button class="mini-nav-btn next" onclick="moveProductImage(this, 1)">&#10095;</button>
                                    </div>
                                <% } %>
                            </div>
                        <% } else { %>
                            <img src="https://placehold.co/600x400?text=<%= product.brand %> <%= product.model %>" class="card-img-top" alt="<%= product.brand %> <%= product.model %>">
                        <% } %>
                        <div class="card-body d-flex flex-column">
                            <h5 class="card-title">üöó <%= product.brand %> <%= product.model %></h5>
                            <p class="card-text mb-1">üé® <strong><%= __('home.product.color') %>:</strong> <%= product.color %></p>
                            <p class="card-text mb-1">üìÖ <strong><%= __('home.product.year') %>:</strong> <%= product.year %></p>
                            <p class="card-text mb-1">üí∂ <strong><%= __('home.product.price') %>:</strong> <%= typeof product.price !== 'undefined' ? product.price.toLocaleString('es-ES', { style: 'currency', currency: 'EUR' }) : '' %></p>
                            <p class="card-text mb-2">üèÅ <strong><%= __('home.product.kilometer') %>:</strong> <%= typeof product.kilometer !== 'undefined' ? product.kilometer.toLocaleString('es-ES') : '' %> km</p>
                        </div>
                        <a href="/products/detail/<%= product.id%>" class="btn btn-primary mt-auto"><%= __('home.detailsButton') %></a>
                    </div>
                </div>
            <% }) %>
        <% } else { %>
            <div class="col-12">
                <p class="text-center text-muted"><%= __('home.noProducts') %></p>
            </div>
        <% } %>
    </div>

    <% if (count > limit) { %>
        <nav aria-label="Page navigation" class="d-flex justify-content-center mt-3 mb-2">
            <ul class="pagination pagination-sm">
                <% if (skip > 0) { %>
                    <li class="page-item"><a class="page-link" href="?skip=<%= Math.max(0, skip - limit) %>&limit=<%= limit %>&sort=<%= sort %>"><%= __('common.previous') %></a></li>
                <% } else { %>
                    <li class="page-item disabled"><span class="page-link"><%= __('common.previous') %></span></li>
                <% } %>
                <% const totalPages = Math.ceil(count / limit); %>
                <% const currentPage = Math.floor(skip / limit) + 1; %>
                <% for (let i = Math.max(1, currentPage - 2); i <= Math.min(totalPages, currentPage + 2); i++) { %>
                    <li class="page-item <%= i === currentPage ? 'active' : '' %>">
                        <a class="page-link" href="?skip=<%= (i - 1) * limit %>&limit=<%= limit %>&sort=<%= sort %>"><%= i %></a>
                    </li>
                <% } %>
                <% if (skip + limit < count) { %>
                    <li class="page-item"><a class="page-link" href="?skip=<%= skip + limit %>&limit=<%= limit %>&sort=<%= sort %>"><%= __('common.next') %></a></li>
                <% } else { %>
                    <li class="page-item disabled"><span class="page-link"><%= __('common.next') %></span></li>
                <% } %>
            </ul>
        </nav>
    <% } %>
</main>
<script>
    document.addEventListener('DOMContentLoaded', function() {
        // Verificar si es una carga directa o navegaci√≥n con par√°metros
        const urlParams = new URLSearchParams(window.location.search);
        const isDirectLoad = !urlParams.has('skip') && !urlParams.has('limit') && !urlParams.has('sort') && 
                            !urlParams.has('brand') && !urlParams.has('model') && !urlParams.has('color') &&
                            !urlParams.has('year') && !urlParams.has('price') && !urlParams.has('kilometer');
        
        // Obtener referencias a elementos del splash
        const splashContainer = document.querySelector('.splash-container');
        const logoContainer = document.querySelector('.logo-container');
        
        if (!splashContainer || !logoContainer) {
            console.error('Elementos del splash no encontrados');
            document.body.classList.remove('splash-active');
            return;
        }
        
        // Mostrar splash solo si es carga directa
        if (isDirectLoad) {
            // Asegurar que el contenido principal est√° oculto mientras se muestra el splash
            document.body.classList.add('splash-active');
            
            // Asegurar que el splash es visible
            splashContainer.style.display = 'flex';
            
            // Iniciar animaci√≥n de zoom
            setTimeout(function() {
                logoContainer.classList.add('zoom-in');
            }, 200);
            
            // Efecto de pulso m√°s r√°pido
            setTimeout(function() {
                logoContainer.classList.add('pulse');
            }, 1400);
            
            // Iniciar desvanecimiento m√°s r√°pido
            setTimeout(function() {
                splashContainer.classList.add('fade-out');
            }, 2000);
            
            // Ocultar splash y mostrar el contenido m√°s r√°pido
            setTimeout(function() {
                splashContainer.style.display = 'none';
                document.body.classList.remove('splash-active');
                console.log('Splash ocultado, contenido principal visible');
            }, 2300);
        } else {
            // Si no es carga directa, ocultar el splash inmediatamente
            splashContainer.style.display = 'none';
            document.body.classList.remove('splash-active');
        }
    });
    
    function toggleFilters() {
        const filterForm = document.getElementById('filter-form');
        if (filterForm.style.display === 'none') {
            filterForm.style.display = 'block';
        } else {
            filterForm.style.display = 'none';
        }
    }

    // Funci√≥n para manejar el carrusel de im√°genes en cada tarjeta de producto
    function moveProductImage(buttonElement, direction) {
        // Prevenir la navegaci√≥n a la p√°gina de detalles al hacer clic en los botones
        event.preventDefault();
        event.stopPropagation();
        
        // Obtener el contenedor del carrusel (padre del bot√≥n)
        const carousel = buttonElement.closest('.carousel-nav').parentElement;
        
        // Obtener la imagen activa actual
        const currentImg = carousel.querySelector('img.active-image');
        const currentIndex = parseInt(currentImg.dataset.index || 0);
        
        // Obtener todas las im√°genes del producto
        const productId = carousel.closest('.ProductCard').querySelector('a').getAttribute('href').split('/').pop();
        const allImages = (product_images[productId] || []);
        
        if (allImages.length <= 1) return; // No hacer nada si hay 0 o 1 im√°genes
        
        // Calcular el nuevo √≠ndice (con manejo circular)
        const newIndex = (currentIndex + direction + allImages.length) % allImages.length;
        
        // Determinar la ruta correcta seg√∫n el tipo de imagen
        const imagePath = allImages[newIndex];
        const imgSrc = imagePath.startsWith('img_cars/') ? `/${imagePath}` : `/imagenes/${imagePath}`;
        
        // Actualizar la imagen
        currentImg.src = imgSrc;
        currentImg.dataset.index = newIndex;
        
        console.log(`Producto ${productId}: Mostrando imagen ${newIndex+1} de ${allImages.length}`);
    }
</script>
<%-include("footer.ejs") %>
